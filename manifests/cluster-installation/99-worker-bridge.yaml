apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: worker-nmstate-bridge
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
        - contents:
            source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKCkRFRkFVTFRfTVRVPTE1MDAKTk9ERVNfTVRVPSR7MTotJERFRkFVTFRfTVRVfQoKIyBXYWl0IGluZGVmaW5pdGVseSBmb3IgYW4gaW50ZXJmYWNlIHRvIGdldCBhbiBJUCBhZGRyZXNzIGFuZCBkZWZhdWx0IHJvdXRlCldBSVRfSU5URVJWQUw9NSAgIyBDaGVjayBpbnRlcnZhbCBpbiBzZWNvbmRzCkFUVEVNUFQ9MQoKZWNobyAiV2FpdGluZyBmb3IgbmV0d29yayBjb25maWd1cmF0aW9uLi4uIgp3aGlsZSB0cnVlOyBkbwogICAgIyBDaGVjayBpZiB3ZSBoYXZlIGFuIGludGVyZmFjZSB3aXRoIGEgZGVmYXVsdCByb3V0ZQogICAgREVGQVVMVF9JTlRFUkZBQ0U9JChpcCByb3V0ZSB8IGdyZXAgZGVmYXVsdCB8IGF3ayAne3ByaW50ICQ1fScgfCBoZWFkIC1uIDEpCgogICAgaWYgWyAtbiAiJERFRkFVTFRfSU5URVJGQUNFIiBdOyB0aGVuCiAgICAgICAgIyBDaGVjayBpZiB0aGF0IGludGVyZmFjZSBoYXMgYW4gSVAgYWRkcmVzcwogICAgICAgIElQX0FERFI9JChpcCBhZGRyIHNob3cgZGV2ICIkREVGQVVMVF9JTlRFUkZBQ0UiIHwgZ3JlcCAtdyAiaW5ldCIgfCBhd2sgJ3twcmludCAkMn0nKQoKICAgICAgICBpZiBbIC1uICIkSVBfQUREUiIgXTsgdGhlbgogICAgICAgICAgICBlY2hvICJOZXR3b3JrIGlzIHJlYWR5LiBJbnRlcmZhY2UgJERFRkFVTFRfSU5URVJGQUNFIGhhcyBJUCBhZGRyZXNzICRJUF9BRERSIgogICAgICAgICAgICBicmVhawogICAgICAgIGZpCiAgICBmaQoKICAgIGVjaG8gIldhaXRpbmcgZm9yIG5ldHdvcmsgY29uZmlndXJhdGlvbi4uLiAoQXR0ZW1wdCAkQVRURU1QVCkiCiAgICBzbGVlcCAkV0FJVF9JTlRFUlZBTAogICAgQVRURU1QVD0kKChBVFRFTVBUICsgMSkpCmRvbmUKCiMgQ2hlY2sgaWYgdGhlIGJyaWRnZSBhbHJlYWR5IGV4aXN0cwppZiBpcCBsaW5rIHNob3cgYnItZHB1ICY+L2Rldi9udWxsOyB0aGVuCiAgICBlY2hvICJCcmlkZ2UgYnItZHB1IGFscmVhZHkgZXhpc3RzLiBObyBuZWVkIHRvIGNvbmZpZ3VyZSBpdC4iCiAgICBleGl0IDAKZmkKCiMgRmluZCB0aGUgaW50ZXJmYWNlIHRoYXQgaGFzIHRoZSBkZWZhdWx0IHJvdXRlCkRFRkFVTFRfSU5URVJGQUNFPSQoaXAgcm91dGUgfCBncmVwIGRlZmF1bHQgfCBhd2sgJ3twcmludCAkNX0nIHwgaGVhZCAtbiAxKQoKaWYgWyAteiAiJERFRkFVTFRfSU5URVJGQUNFIiBdOyB0aGVuCiAgICBlY2hvICJFcnJvcjogQ291bGQgbm90IGZpbmQgaW50ZXJmYWNlIHdpdGggZGVmYXVsdCByb3V0ZSIgPiYyCiAgICBleGl0IDEKZmkKCmVjaG8gIkZvdW5kIGRlZmF1bHQgaW50ZXJmYWNlOiAkREVGQVVMVF9JTlRFUkZBQ0UiCgojIENyZWF0ZSBhIHRlbXBvcmFyeSBZQU1MIGZpbGUgd2l0aCB0aGUgaW50ZXJmYWNlIHN1YnN0aXR1dGVkClRNUF9GSUxFPSQobWt0ZW1wKQoKY2F0ID4gIiRUTVBfRklMRSIgPDwgRU9GCmludGVyZmFjZXM6CiAgLSBuYW1lOiBici1kcHUKICAgIHR5cGU6IGxpbnV4LWJyaWRnZQogICAgc3RhdGU6IHVwCiAgICBtdHU6ICROT0RFU19NVFUKICAgIGlwdjY6CiAgICAgIGVuYWJsZWQ6IGZhbHNlCiAgICBpcHY0OgogICAgICBlbmFibGVkOiB0cnVlCiAgICAgIGRoY3A6IHRydWUKICAgICAgYXV0by1kbnM6IHRydWUKICAgICAgYXV0by1nYXRld2F5OiB0cnVlCiAgICAgIGF1dG8tcm91dGVzOiB0cnVlCiAgICBicmlkZ2U6CiAgICAgIG9wdGlvbnM6CiAgICAgICAgc3RwOgogICAgICAgICAgZW5hYmxlZDogZmFsc2UKICAgICAgcG9ydDoKICAgICAgICAtIG5hbWU6ICRERUZBVUxUX0lOVEVSRkFDRQogIC0gbmFtZTogJERFRkFVTFRfSU5URVJGQUNFCiAgICB0eXBlOiBldGhlcm5ldAogICAgc3RhdGU6IHVwCiAgICBtdHU6ICROT0RFU19NVFUKRU9GCgplY2hvICJDcmVhdGVkIE5NU3RhdGUgY29uZmlndXJhdGlvbiB3aXRoIGludGVyZmFjZSAkREVGQVVMVF9JTlRFUkZBQ0UiCmVjaG8gIkFwcGx5aW5nIGNvbmZpZ3VyYXRpb24gdXNpbmcgbm1zdGF0ZWN0bC4uLiIKCiMgQXBwbHkgdGhlIGNvbmZpZ3VyYXRpb24Kbm1zdGF0ZWN0bCBhcHBseSAiJFRNUF9GSUxFIgpSRVNVTFQ9JD8KCiMgQ2xlYW4gdXAKcm0gIiRUTVBfRklMRSIKCiMgUmV0dXJuIHRoZSByZXN1bHQKZXhpdCAkUkVTVUxUCg==
          mode: 0755
          overwrite: true
          path: /usr/local/bin/apply-nmstate-bridge.sh
        - contents:
            source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKCiMgU2NyaXB0IHRvIHdhaXQgZm9yIE9WTi1LIGludGVyZmFjZSAoaWRlbnRpZmllZCBieSBsaW5rLWxvY2FsKSBhbmQgY29uZmlndXJlIHJvdXRpbmcgdGFibGUgMTAwCgpDSEVDS19JTlRFUlZBTD0yICAjIENoZWNrIGV2ZXJ5IDIgc2Vjb25kcwpQUklNQVJZX0lQX0ZJTEU9Ii9ydW4vbm9kZWlwLWNvbmZpZ3VyYXRpb24vcHJpbWFyeS1pcCIKCmVjaG8gIldhaXRpbmcgZm9yIHByaW1hcnkgSVAgZmlsZSB0byBkZXRlcm1pbmUgSVAgdmVyc2lvbi4uLiIKCiMgV2FpdCBmb3IgcHJpbWFyeS1pcCBmaWxlIGFuZCBkZXRlcm1pbmUgSVAgdmVyc2lvbiBmaXJzdAp3aGlsZSBbICEgLWYgIiRQUklNQVJZX0lQX0ZJTEUiIF0gfHwgWyAhIC1zICIkUFJJTUFSWV9JUF9GSUxFIiBdOyBkbwogICAgc2xlZXAgJENIRUNLX0lOVEVSVkFMCmRvbmUKCmJyX2RwdV9pcD0kKGNhdCAiJFBSSU1BUllfSVBfRklMRSIgfCB0ciAtZCAnWzpzcGFjZTpdJykKZWNobyAiVXNpbmcgYnItZHB1IElQIGZyb20gJFBSSU1BUllfSVBfRklMRTogJGJyX2RwdV9pcCIKCiMgRGV0ZWN0IElQIHZlcnNpb24gYmFzZWQgb24gYnItZHB1IElQIGFuZCBzZXQgYWxsIHZhcmlhYmxlcyBhY2NvcmRpbmdseQppZiBbWyAiJGJyX2RwdV9pcCIgPX4gOiBdXTsgdGhlbgogICAgSVBfVkVSU0lPTj0iNiIKICAgIElQX0ZMQUc9Ii02IgogICAgUFJFRklYX0xFTj0iMTI4IgogICAgTElOS19MT0NBTF9QQVRURVJOPSJeZmU4MDoiCiAgICBlY2hvICJEZXRlY3RlZCBJUHY2IGNvbmZpZ3VyYXRpb24iCmVsc2UKICAgIElQX1ZFUlNJT049IjQiCiAgICBJUF9GTEFHPSItNCIKICAgIFBSRUZJWF9MRU49IjMyIgogICAgTElOS19MT0NBTF9QQVRURVJOPSJeMTY5Wy5dMjU0IgogICAgZWNobyAiRGV0ZWN0ZWQgSVB2NCBjb25maWd1cmF0aW9uIgpmaQoKZWNobyAiV2FpdGluZyBmb3IgT1ZOLUsgaW50ZXJmYWNlICh3aXRoIGxpbmstbG9jYWwgYWRkcmVzcykgdG8gZ2V0IGFuIElQIGFkZHJlc3MuLi4iCgp3aGlsZSB0cnVlOyBkbwogICAgIyBGaW5kIGFsbCBpbnRlcmZhY2VzIHdpdGggbGluay1sb2NhbCBhZGRyZXNzZXMgdXNpbmcgSlNPTiBvdXRwdXQKICAgIG92bmtfaWZhY2VzPSQoaXAgLWogYWRkciBzaG93IHwganEgLXIgJy5bXSB8IHNlbGVjdCguYWRkcl9pbmZvW10/IHwgLmxvY2FsIHwgdGVzdCgiJyIkTElOS19MT0NBTF9QQVRURVJOIiciKSkgfCAuaWZuYW1lJyB8IHNvcnQgLXUpCiAgICAKICAgIGZvciBvdm5rX2lmYWNlIGluICRvdm5rX2lmYWNlczsgZG8KICAgICAgICAjIEdldCBub24tbGluay1sb2NhbCBJUCBhZGRyZXNzIGZvciB0aGUgZGV0ZWN0ZWQgSVAgdmVyc2lvbgogICAgICAgIG92bmtfaXA9JChpcCAkSVBfRkxBRyAtaiBhZGRyIHNob3cgIiRvdm5rX2lmYWNlIiB8IGpxIC1yICcuW10gfCAuYWRkcl9pbmZvW10/IHwgc2VsZWN0KC5sb2NhbCB8IHRlc3QoIiciJExJTktfTE9DQUxfUEFUVEVSTiInIikgfCBub3QpIHwgLmxvY2FsJyB8IGhlYWQgLW4xKQogICAgICAgIAogICAgICAgIGlmIFsgLW4gIiRvdm5rX2lwIiBdOyB0aGVuCiAgICAgICAgICAgIGVjaG8gIkZvdW5kIE9WTi1LIGludGVyZmFjZTogJG92bmtfaWZhY2Ugd2l0aCBJUHYke0lQX1ZFUlNJT059OiAkb3Zua19pcCIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2V0IGJyLWRwdSBuZXR3b3JrIGZyb20gcm91dGluZyB0YWJsZSB1c2luZyBKU09OCiAgICAgICAgICAgIGJyX2RwdV9uZXR3b3JrPSQoaXAgJElQX0ZMQUcgLWogcm91dGUgc2hvdyBkZXYgYnItZHB1IHwganEgLXIgJy5bXSB8IHNlbGVjdCgucHJvdG9jb2wgPT0gImtlcm5lbCIpIHwgLmRzdCcgfCBoZWFkIC1uMSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIFsgLXogIiRicl9kcHVfbmV0d29yayIgXTsgdGhlbgogICAgICAgICAgICAgICAgZWNobyAiRXJyb3I6IENvdWxkIG5vdCBmaW5kIGJyLWRwdSBuZXR3b3JrIgogICAgICAgICAgICAgICAgZXhpdCAxCiAgICAgICAgICAgIGZpCiAgICAgICAgICAgIAogICAgICAgICAgICBlY2hvICJici1kcHUgbmV0d29yazogJGJyX2RwdV9uZXR3b3JrIgogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgYnItZHB1IGdhdGV3YXkgZnJvbSBkZWZhdWx0IHJvdXRlCiAgICAgICAgICAgIGJyX2RwdV9nYXRld2F5PSQoaXAgJElQX0ZMQUcgLWogcm91dGUgfCBqcSAtciAnLltdIHwgc2VsZWN0KC5kc3QgPT0gImRlZmF1bHQiIGFuZCAuZGV2ID09ICJici1kcHUiKSB8IC5nYXRld2F5JyB8IGhlYWQgLW4xKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgWyAteiAiJGJyX2RwdV9nYXRld2F5IiBdOyB0aGVuCiAgICAgICAgICAgICAgICBlY2hvICJFcnJvcjogQ291bGQgbm90IGZpbmQgZ2F0ZXdheSBmb3IgYnItZHB1IgogICAgICAgICAgICAgICAgZXhpdCAxCiAgICAgICAgICAgIGZpCiAgICAgICAgICAgIAogICAgICAgICAgICBlY2hvICJici1kcHUgZ2F0ZXdheTogJGJyX2RwdV9nYXRld2F5IgogICAgICAgICAgICAKICAgICAgICAgICAgIyBHZXQgT1ZOLUsgc3VibmV0IGZyb20gREhDUCByb3V0ZQogICAgICAgICAgICBvdm5rX3N1Ym5ldD0kKGlwICRJUF9GTEFHIC1qIHJvdXRlIHwganEgLXIgIi5bXSB8IHNlbGVjdCguZGV2ID09IFwiJG92bmtfaWZhY2VcIiBhbmQgLnByb3RvY29sID09IFwiZGhjcFwiIGFuZCAuZHN0ICE9IFwiZGVmYXVsdFwiKSB8IC5kc3QiIHwgaGVhZCAtbjEpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBbIC16ICIkb3Zua19zdWJuZXQiIF07IHRoZW4KICAgICAgICAgICAgICAgIGVjaG8gIkVycm9yOiBDb3VsZCBub3QgZmluZCBzdWJuZXQgZm9yICRvdm5rX2lmYWNlIgogICAgICAgICAgICAgICAgZXhpdCAxCiAgICAgICAgICAgIGZpCiAgICAgICAgICAgIAogICAgICAgICAgICBlY2hvICJPVk4tSyBzdWJuZXQ6ICRvdm5rX3N1Ym5ldCIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2V0IG1ldHJpYyBmcm9tIGJyLWRwdSAoZGVmYXVsdCB0byA0MjUgaWYgbm90IGZvdW5kKQogICAgICAgICAgICBicl9kcHVfbWV0cmljPSQoaXAgJElQX0ZMQUcgLWogcm91dGUgc2hvdyBkZXYgYnItZHB1IHwganEgLXIgJy5bXSB8IHNlbGVjdCgucHJvdG9jb2wgPT0gImtlcm5lbCIpIHwgLm1ldHJpYyAvLyA0MjUnIHwgaGVhZCAtbjEpCiAgICAgICAgICAgIAogICAgICAgICAgICBlY2hvICIiCiAgICAgICAgICAgIGVjaG8gIkNyZWF0aW5nIHJvdXRpbmcgcnVsZXMgaW4gdGFibGUgMTAwLi4uIgogICAgICAgICAgICAKICAgICAgICAgICAgIyAxLiBBZGQgcG9saWN5IHJvdXRpbmcgcnVsZQogICAgICAgICAgICBlY2hvICJBZGRpbmcgcnVsZTogZnJvbSAkYnJfZHB1X2lwLyRQUkVGSVhfTEVOIGxvb2t1cCAxMDAiCiAgICAgICAgICAgIGlwICRJUF9GTEFHIHJ1bGUgYWRkIGZyb20gJGJyX2RwdV9pcC8kUFJFRklYX0xFTiBsb29rdXAgMTAwIDI+L2Rldi9udWxsIHx8IGVjaG8gIlJ1bGUgYWxyZWFkeSBleGlzdHMgb3IgZmFpbGVkIgogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBBZGQgT1ZOLUsgcm91dGUgdmlhIGdhdGV3YXkKICAgICAgICAgICAgZWNobyAiQWRkaW5nIHJvdXRlOiAkb3Zua19zdWJuZXQgdmlhICRicl9kcHVfZ2F0ZXdheSB0YWJsZSAxMDAiCiAgICAgICAgICAgIGlwICRJUF9GTEFHIHJvdXRlIGFkZCAkb3Zua19zdWJuZXQgdmlhICRicl9kcHVfZ2F0ZXdheSB0YWJsZSAxMDAgMj4vZGV2L251bGwgfHwgZWNobyAiUm91dGUgYWxyZWFkeSBleGlzdHMgb3IgZmFpbGVkIgogICAgICAgICAgICAKICAgICAgICAgICAgIyAzLiBBZGQgYnItZHB1IHN1Ym5ldCByb3V0ZQogICAgICAgICAgICBlY2hvICJBZGRpbmcgcm91dGU6ICRicl9kcHVfbmV0d29yayBkZXYgYnItZHB1IHByb3RvIGtlcm5lbCBzY29wZSBsaW5rIHNyYyAkYnJfZHB1X2lwIG1ldHJpYyAkYnJfZHB1X21ldHJpYyB0YWJsZSAxMDAiCiAgICAgICAgICAgIGlwICRJUF9GTEFHIHJvdXRlIGFkZCAkYnJfZHB1X25ldHdvcmsgZGV2IGJyLWRwdSBwcm90byBrZXJuZWwgc2NvcGUgbGluayBzcmMgJGJyX2RwdV9pcCBtZXRyaWMgJGJyX2RwdV9tZXRyaWMgdGFibGUgMTAwIDI+L2Rldi9udWxsIHx8IGVjaG8gIlJvdXRlIGFscmVhZHkgZXhpc3RzIG9yIGZhaWxlZCIKICAgICAgICAgICAgCiAgICAgICAgICAgIGVjaG8gIiIKICAgICAgICAgICAgZWNobyAiUm91dGluZyBjb25maWd1cmF0aW9uIGNvbXBsZXRlZCEiCiAgICAgICAgICAgIGV4aXQgMAogICAgICAgIGZpCiAgICBkb25lCiAgICAKICAgIHNsZWVwICRDSEVDS19JTlRFUlZBTApkb25l
          mode: 0755
          overwrite: true
          path: /usr/local/bin/configure-p0-routing.sh
    systemd:
      units:
        - contents: |
            [Unit]
            Description=Apply NMState bridge configuration
            After=network.target NetworkManager.service
            Wants=NetworkManager.service
            
            [Service]
            Type=oneshot
            ExecStart=/usr/local/bin/apply-nmstate-bridge.sh <NODES_MTU>
            RemainAfterExit=yes
            
            [Install]
            WantedBy=multi-user.target
          enabled: true
          name: nmstate-bridge.service
        - name: ovs-configuration.service
          enabled: false
        - name: openvswitch.service
          enabled: false
          mask: true
        - name: wait-for-br-ex-up.service
          enabled: false
        - name: p0-routing.service
          enabled: true
          contents: |
            [Unit]
            Description=Configure p0 interface routing
            After=kubelet.service network-online.target
            Wants=network-online.target
            
            [Service]
            Type=oneshot
            ExecStart=/usr/local/bin/configure-p0-routing.sh
            RemainAfterExit=yes
            StandardOutput=journal
            StandardError=journal
            
            [Install]
            WantedBy=multi-user.target
