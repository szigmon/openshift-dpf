apiVersion: machineconfiguration.openshift.io/v1
kind: MachineConfig
metadata:
  labels:
    machineconfiguration.openshift.io/role: worker
  name: worker-nmstate-bridge
spec:
  config:
    ignition:
      version: 3.2.0
    storage:
      files:
        - contents:
            source: data:text/plain;charset=utf-8;base64,IyEvYmluL2Jhc2gKCkRFRkFVTFRfTVRVPTE1MDAKTk9ERVNfTVRVPSR7MTotJERFRkFVTFRfTVRVfQoKIyBXYWl0IGluZGVmaW5pdGVseSBmb3IgYW4gaW50ZXJmYWNlIHRvIGdldCBhbiBJUCBhZGRyZXNzIGFuZCBkZWZhdWx0IHJvdXRlCldBSVRfSU5URVJWQUw9NSAgIyBDaGVjayBpbnRlcnZhbCBpbiBzZWNvbmRzCkFUVEVNUFQ9MQoKZWNobyAiV2FpdGluZyBmb3IgbmV0d29yayBjb25maWd1cmF0aW9uLi4uIgp3aGlsZSB0cnVlOyBkbwogICAgIyBDaGVjayBpZiB3ZSBoYXZlIGFuIGludGVyZmFjZSB3aXRoIGEgZGVmYXVsdCByb3V0ZQogICAgREVGQVVMVF9JTlRFUkZBQ0U9JChpcCByb3V0ZSB8IGdyZXAgZGVmYXVsdCB8IGF3ayAne3ByaW50ICQ1fScgfCBoZWFkIC1uIDEpCgogICAgaWYgWyAtbiAiJERFRkFVTFRfSU5URVJGQUNFIiBdOyB0aGVuCiAgICAgICAgIyBDaGVjayBpZiB0aGF0IGludGVyZmFjZSBoYXMgYW4gSVAgYWRkcmVzcwogICAgICAgIElQX0FERFI9JChpcCBhZGRyIHNob3cgZGV2ICIkREVGQVVMVF9JTlRFUkZBQ0UiIHwgZ3JlcCAtdyAiaW5ldCIgfCBhd2sgJ3twcmludCAkMn0nKQoKICAgICAgICBpZiBbIC1uICIkSVBfQUREUiIgXTsgdGhlbgogICAgICAgICAgICBlY2hvICJOZXR3b3JrIGlzIHJlYWR5LiBJbnRlcmZhY2UgJERFRkFVTFRfSU5URVJGQUNFIGhhcyBJUCBhZGRyZXNzICRJUF9BRERSIgogICAgICAgICAgICBicmVhawogICAgICAgIGZpCiAgICBmaQoKICAgIGVjaG8gIldhaXRpbmcgZm9yIG5ldHdvcmsgY29uZmlndXJhdGlvbi4uLiAoQXR0ZW1wdCAkQVRURU1QVCkiCiAgICBzbGVlcCAkV0FJVF9JTlRFUlZBTAogICAgQVRURU1QVD0kKChBVFRFTVBUICsgMSkpCmRvbmUKCiMgQ2hlY2sgaWYgdGhlIGJyaWRnZSBhbHJlYWR5IGV4aXN0cwppZiBpcCBsaW5rIHNob3cgYnItZHB1ICY+L2Rldi9udWxsOyB0aGVuCiAgICBlY2hvICJCcmlkZ2UgYnItZHB1IGFscmVhZHkgZXhpc3RzLiBObyBuZWVkIHRvIGNvbmZpZ3VyZSBpdC4iCiAgICBleGl0IDAKZmkKCiMgRmluZCB0aGUgaW50ZXJmYWNlIHRoYXQgaGFzIHRoZSBkZWZhdWx0IHJvdXRlCkRFRkFVTFRfSU5URVJGQUNFPSQoaXAgcm91dGUgfCBncmVwIGRlZmF1bHQgfCBhd2sgJ3twcmludCAkNX0nIHwgaGVhZCAtbiAxKQoKaWYgWyAteiAiJERFRkFVTFRfSU5URVJGQUNFIiBdOyB0aGVuCiAgICBlY2hvICJFcnJvcjogQ291bGQgbm90IGZpbmQgaW50ZXJmYWNlIHdpdGggZGVmYXVsdCByb3V0ZSIgPiYyCiAgICBleGl0IDEKZmkKCmVjaG8gIkZvdW5kIGRlZmF1bHQgaW50ZXJmYWNlOiAkREVGQVVMVF9JTlRFUkZBQ0UiCgojIENyZWF0ZSBhIHRlbXBvcmFyeSBZQU1MIGZpbGUgd2l0aCB0aGUgaW50ZXJmYWNlIHN1YnN0aXR1dGVkClRNUF9GSUxFPSQobWt0ZW1wKQoKY2F0ID4gIiRUTVBfRklMRSIgPDwgRU9GCmludGVyZmFjZXM6CiAgLSBuYW1lOiBici1kcHUKICAgIHR5cGU6IGxpbnV4LWJyaWRnZQogICAgc3RhdGU6IHVwCiAgICBtdHU6ICROT0RFU19NVFUKICAgIGlwdjY6CiAgICAgIGVuYWJsZWQ6IGZhbHNlCiAgICBpcHY0OgogICAgICBlbmFibGVkOiB0cnVlCiAgICAgIGRoY3A6IHRydWUKICAgICAgYXV0by1kbnM6IHRydWUKICAgICAgYXV0by1nYXRld2F5OiB0cnVlCiAgICAgIGF1dG8tcm91dGVzOiB0cnVlCiAgICBicmlkZ2U6CiAgICAgIG9wdGlvbnM6CiAgICAgICAgc3RwOgogICAgICAgICAgZW5hYmxlZDogZmFsc2UKICAgICAgcG9ydDoKICAgICAgICAtIG5hbWU6ICRERUZBVUxUX0lOVEVSRkFDRQogIC0gbmFtZTogJERFRkFVTFRfSU5URVJGQUNFCiAgICB0eXBlOiBldGhlcm5ldAogICAgc3RhdGU6IHVwCiAgICBtdHU6ICROT0RFU19NVFUKRU9GCgplY2hvICJDcmVhdGVkIE5NU3RhdGUgY29uZmlndXJhdGlvbiB3aXRoIGludGVyZmFjZSAkREVGQVVMVF9JTlRFUkZBQ0UiCmVjaG8gIkFwcGx5aW5nIGNvbmZpZ3VyYXRpb24gdXNpbmcgbm1zdGF0ZWN0bC4uLiIKCiMgQXBwbHkgdGhlIGNvbmZpZ3VyYXRpb24Kbm1zdGF0ZWN0bCBhcHBseSAiJFRNUF9GSUxFIgpSRVNVTFQ9JD8KCiMgQ2xlYW4gdXAKcm0gIiRUTVBfRklMRSIKCiMgUmV0dXJuIHRoZSByZXN1bHQKZXhpdCAkUkVTVUxUCg==
          mode: 0755
          overwrite: true
          path: /usr/local/bin/apply-nmstate-bridge.sh
    systemd:
      units:
        - contents: |
            [Unit]
            Description=Apply NMState bridge configuration
            After=network.target NetworkManager.service
            Wants=NetworkManager.service
            
            [Service]
            Type=oneshot
            ExecStart=/usr/local/bin/apply-nmstate-bridge.sh <NODES_MTU>
            RemainAfterExit=yes
            
            [Install]
            WantedBy=multi-user.target
          enabled: true
          name: nmstate-bridge.service
